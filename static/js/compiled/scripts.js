// Generated by CoffeeScript 1.6.3
/*
	@author: nicolasbrugneaux.me
*/


(function() {
  var blogify, changePage, index, last, linkify, loadFrom, pages, showNextPosts, slideUpDownNotifications, supports3DTransforms;

  slideUpDownNotifications = function() {
    if ($(".notifications").children().size() === 1) {
      return $(".notifications").hide();
    } else {
      return $(".notifications").slideUp(0).slideDown(150).delay(5000).slideUp(150);
    }
  };

  /*
      @inspired: by hakim.se
  */


  supports3DTransforms = document.body.style['webkitPerspective'] === !void 0 || document.body.style['MozPerspective'] === !void 0;

  linkify = function(selector) {
    var node, nodes, _i, _len, _results;
    if (supports3DTransforms) {
      nodes = document.querySelectorAll(selector);
      _results = [];
      for (_i = 0, _len = nodes.length; _i < _len; _i++) {
        node = nodes[_i];
        if (!node.className || !node.className.match(/roll/g)) {
          node.className += ' roll';
          _results.push(node.innerHTML = '<span data-title="' + node.text(+'">' + node.innerHTML + '</span>'));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    }
  };

  /*
  	@author: nicolasbrugneaux.me
  */


  last = 0;

  blogify = function() {
    return $.ajax({
      url: './database/posts.php',
      data: "",
      dataType: 'json',
      success: function(data) {
        var content, index, item, _i, _len;
        content = "";
        for (index = _i = 0, _len = data.length; _i < _len; index = ++_i) {
          item = data[index];
          if (item === data[0]) {
            content += ("<div class='row'>						<div class='span12'>							<h2>" + item['title'] + "</a></h2>							<small><b>By " + item['author'] + " </b>, <i> " + item['created'] + "</i></small>							<br>							<div class='post'>								" + item['body'] + "							</div>							<div id='modal-" + item['id'] + "'class='modal hide fade' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'>								<div class='modal-header'>									<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>×</button									<h3>" + item['title'] + "</h3>									<small><b>By " + item['author'] + " </b>, <i>" + item['created'] + "</i></small>									<br>								</div> <!-- .modal-header -->								<div class='modal-body'>									" + item['body'] + "								</div> <!-- .modal-body -->								<div class='modal-footer'>									<!-- FACEBOOK SHARE BUTTON -->									<a class='btn facebook'										href='http://www.facebook.com/sharer.php?s=100										&p[title]=\"") + item['title'].replace(/<[^>]*>/g, '') + "\"										&p[summary]=\"" + $.trim(item['body'].replace(/<[^>]*>/g, '')).substring(0, 100).split(" ").slice(0, -1).join(" ") + ("...\"										&p[url]=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"'										target='_blank'>										<span data-icon='&#xe164;'> </span> Share									</a>									<!-- TWEET BUTTON -->									<a class='btn twitter'										href='https://twitter.com/share										?url=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"										&via=nicolasbrugneaux.me										&text=" + item['title'] + " -'										target='_blank'>										<span data-icon='&#xe169;'> </span> Tweet									</a>													<button class='btn' data-dismiss='modal' aria-hidden='true'>Close</button>								</div><!-- .modal-footer -->							</div><!-- #modal-id -->							<a href='#modal-" + item['id'] + "' role='button' class='btn btn-info' data-toggle='modal'>Share this post »</a>						</div> <!-- .span12 -->					</div><!-- .row -->");
          } else {
            content += index % 3 === 1 ? "<hr><div class='row previews'>" : "";
            content += ("<div class='span4'>							<h2>" + item['title'] + "</h2>							<small><b>By " + item['author'] + "</b>, <i>" + item['created'] + "</i></small>							<br>							<div class='post'>") + $.trim(item['body']).substring(0, 200).split(" ").slice(0, -1).join(" ") + ("...</div>							<div id='modal-" + item['id'] + "'class='modal hide fade' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'>								<div class='modal-header'>									<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>×</button>									<h3>" + item['title'] + "</h3>									<small><b>By " + item['author'] + "</b>, <i>" + item['created'] + "</i></small>									<br>								</div> <!-- .modal-header -->								<div class='modal-body'>									" + item['body'] + "								</div> <!-- .modal-body -->								<div class='modal-footer'>									<!-- FACEBOOK SHARE BUTTON -->									<a class='btn facebook'										href='http://www.facebook.com/sharer.php?s=100										&p[title]=\"") + item['title'].replace(/<[^>]*>/g, '') + "\"										&p[summary]=\"" + $.trim(item['body'].replace(/<[^>]*>/g, '')).substring(0, 100).split(" ").slice(0, -1).join(" ") + ("...\"										&p[url]=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"'										target='_blank'>										<span data-icon='&#xe164;'> </span> Share									</a>									<!-- TWEET BUTTON -->									<a class='btn twitter'										href='https://twitter.com/share										?url=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"										&via=nicolasbrugneaux.me										&text=" + item['title'] + " -'										target='_blank'>										<span data-icon='&#xe169;'> </span> Tweet									</a>													<button class='btn' data-dismiss='modal' aria-hidden='true'>Close</button>								</div><!-- .modal-footer -->							</div><!-- #modal-id -->							<a href='#modal-" + item['id'] + "' role='button' class='btn btn-info' data-toggle='modal'>Read More »</a>						</div> <!-- .span4 -->");
            content += index % 3 === 0 || index === data.length - 1 ? "</div><!-- .row -->" : "";
          }
        }
        $('#bar .progress .bar').width("100%");
        return window.setTimeout(function() {
          var ft, gy, gys, hu, _j, _len1,
            _this = this;
          $(".blog .container").html(content);
          linkify('.container a.no-btn');
          $('#bar .progress .bar').width("0%");
          $("#btn").show();
          $('#bar').hide();
          if (window.location.search !== '') {
            hu = window.location.search.substring(1);
            gys = hu.split("&");
            for (_j = 0, _len1 = gys.length; _j < _len1; _j++) {
              gy = gys[_j];
              ft = gys.split("=");
              if (ft[0] === "id") {
                $('#modal-' + ft[1]).modal();
              }
            }
          }
          last = data.length;
          return $("#btn .btn").click(function() {
            return showNextPosts(last, 3);
          });
        }, 1000);
      },
      error: function(data) {
        $('#bar .progress .bar').width("0%");
        $('#bar .progress').addClass("progress-danger");
        $('.notifications').append("<div class='alert alert-danger'>					<button class='close' type='button' data-dismiss='alert'>&times;</button>					<p>The last posts couldn't be loaded.</p>				</div>");
        return slideUpDownNotifications();
      }
    });
  };

  showNextPosts = function(from, howMany) {
    $("#btn .btn").attr('disabled', 'disabled');
    $("#btn").hide();
    return $.ajax({
      url: "./database/posts.php?from=" + from + "&howMany=" + howMany,
      data: "",
      dataType: 'json',
      success: function(data) {
        var content, index, item, _i, _len;
        content = "";
        if (!$.isEmptyObject(data)) {
          $('#bar').show();
          for (index = _i = 0, _len = data.length; _i < _len; index = ++_i) {
            item = data[index];
            content += index % 3 === 1 ? "<hr><div class='row previews'>" : "";
            content += ("<div class='span4'>							<h2>" + item['title'] + "</h2>							<small><b>By " + item['author'] + "</b>, <i>" + item['created'] + "</i></small>							<br>							<div class='post'>") + $.trim(item['body']).substring(0, 200).split(" ").slice(0, -1).join(" ") + ("...							</div>							<div id='modal-" + item['id'] + "'class='modal hide fade' tabindex='-1' role='dialog' aria-labelledby='myModalLabel' aria-hidden='true'>								<div class='modal-header'>									<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>×</button>									<h3>" + item['title'] + "</h3>									<small><b>By " + item['author'] + "</b>, <i>" + item['created'] + "</i></small>									<br>								</div> <!-- .modal-header -->							<div class='modal-body'>								" + item['body'] + "							</div> <!-- .modal-body -->							<div class='modal-footer'>								<!-- FACEBOOK SHARE BUTTON -->								<a class='btn facebook'									href='http://www.facebook.com/sharer.php?s=100									&p[title]=\"") + item['title'].replace(/<[^>]*>/g, '')(+"\"									&p[summary]=\"" + $.trim(item['body'].replace(/<[^>]*>/g, '')).substring(0, 100).split(" ").slice(0, -1).join(" ") + ("...\"									&p[url]=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"'									target='_blank'>									<span data-icon='&#xe164;'> </span> Share								</a>								<!-- TWEET BUTTON -->								<a class='btn twitter'									href='https://twitter.com/share									?url=\"http://nicolasbrugneaux.me/posts/?id=" + item['id'] + "\"									&via=nicolasbrugneaux.me									&text=" + item['title'] + " -'									target='_blank'>									<span data-icon='&#xe169;'> </span> Tweet								</a>											<button class='btn' data-dismiss='modal' aria-hidden='true'>Close</button>							</div><!-- .modal-footer -->						</div><!-- #modal-id -->						<a href='#modal-" + item['id'] + "' role='button' class='btn btn-info' data-toggle='modal'>Read More »</a>					</div> <!-- .span4 -->"));
            content += index % 3 === 0 || index === data.length - 1 ? "</div><!-- .row -->" : "";
          }
          $('#bar .progress .bar').width("100%");
          return window.setTimeout(function() {
            var ft, gys, hu, _j, _len1,
              _this = this;
            $(".blog .container").append(content);
            linkify('.container a.no-btn');
            $("#btn").show(function() {
              return $("#btn .btn").removeAttr('disabled');
            });
            $('#bar').hide();
            $('#btn').show();
            $('#bar .progress .bar').width("0%");
            if (window.location.search !== '') {
              hu = window.location.search.substring(1);
              gys = hu.split("&");
              for (_j = 0, _len1 = gys.length; _j < _len1; _j++) {
                gys = gys[_j];
                ft = gy[i].split("=");
                if (ft[0] === "id") {
                  $('#modal-' + ft[1]).modal();
                }
              }
            }
            last = data.length + last;
            return $("#btn .btn").click(function() {
              return showNextPosts(last, 3);
            });
          }, 1000);
        } else if ($('#notif-post').length === 0) {
          content = "<div id='notif-post' class='well well-small' style='text-align:center;'>								<button class='close' type='button' data-dismiss='alert'>&times;</button>								<p>No more posts to show.</p>							</div>";
          $(".blog .loaders").prepend(content);
          $('#bar').hide();
          return $('#btn').hide();
        }
      },
      error: function(data) {
        $('#bar .progress .bar').width("0%");
        $('#bar .progress').addClass("progress-danger");
        $('.notifications').append("<div class='alert alert-danger'>					<button class='close' type='button' data-dismiss='alert'>&times;</button>					<p>The last posts couldn't be loaded.</p>				</div>");
        return slideUpDownNotifications();
      }
    });
  };

  /*
  	@author: nicolasbrugneaux.me
  */


  index = 0;

  pages = ["home", "about", "skills", "contact", "blog"];

  loadFrom = function(from, index) {
    var to;
    to = from === "right" ? "left" : "right";
    return $("#main-content").hide("slide", {
      direction: from
    }, 300, function() {
      return $("#main-content").load("pages/" + pages[index] + ".php", function() {
        $("#main-content").show("slide", {
          direction: to
        }, 500);
        if (window.location.hash.substring(1) === "blog") {
          blogify();
        }
        return linkify('a.no-btn');
      });
    });
  };

  changePage = function(value) {
    var i, key, page, _i, _len;
    i = $.inArray(value, pages);
    if (i !== index) {
      if (i < index) {
        loadFrom("right", i);
      } else {
        loadFrom("left", i);
      }
      for (key = _i = 0, _len = pages.length; _i < _len; key = ++_i) {
        page = pages[key];
        if (key === i) {
          $('#menu-' + page).parent().addClass('active');
        } else {
          $('#menu-' + page).parent().removeClass('active');
        }
      }
      if (value === "skills" || value === "about") {
        $('#menu-about').parent().addClass('active');
      }
      return index = i;
    }
  };

  $(document).ready(function() {
    var i;
    slideUpDownNotifications();
    i = $.inArray((window.location.hash.substring(1) === "" ? 'home' : window.location.hash.substring(1)), pages);
    $("#main-content").load((i === -1 ? "pages/home" : "pages/" + pages[i]) + ".php", function() {
      linkify('a.no-btn');
      if (window.location.hash.substring(1) === "blog") {
        return blogify();
      }
    });
    index = i;
    return $(window).on('hashchange', function() {
      if ($.inArray(window.location.hash.substring(1), pages) >= 0) {
        return changePage(window.location.hash.substring(1));
      } else {
        return changePage("home");
      }
    });
  });

}).call(this);
